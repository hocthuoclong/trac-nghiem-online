<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- ================= SEO Tags ================= -->
    <title>Trắc nghiệm Online - Ôn tập các môn Lớp 1-12</title>
    <meta name="description" content="Nền tảng ôn tập trắc nghiệm miễn phí cho học sinh từ lớp 1 đến lớp 12. Luyện tập các môn Toán, Lý, Hóa,... bám sát chương trình sách giáo khoa.">
    <meta name="keywords" content="trắc nghiệm online, ôn tập, thi thử, kiểm tra, toán, vật lý, hóa học, lớp 1, lớp 2, lớp 3, lớp 4, lớp 5, lớp 6, lớp 7, lớp 8, lớp 9, lớp 10, lớp 11, lớp 12, sách giáo khoa, kết nối tri thức">
    <meta name="author" content="hocthuoclong">
    
    <!-- Google Site Verification -->
    <meta name="google-site-verification" content="LN8vjhgl2L8amNIRx59azvFPVaqGBSZP03KDS9u4dok" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://hocthuoclong.github.io/trac-nghiem-online/">
    <meta property="og:title" content="Trắc nghiệm Online - Ôn tập các môn Lớp 1-12">
    <meta property="og:description" content="Nền tảng ôn tập trắc nghiệm miễn phí cho học sinh từ lớp 1 đến lớp 12. Luyện tập các môn Toán, Lý, Hóa,... bám sát chương trình sách giáo khoa.">
    <meta property="og:image" content="https://hocthuoclong.github.io/trac-nghiem-online/images/logo.png">
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://hocthuoclong.github.io/trac-nghiem-online/">
    <meta property="twitter:title" content="Trắc nghiệm Online - Ôn tập các môn Lớp 1-12">
    <meta property="twitter:description" content="Nền tảng ôn tập trắc nghiệm miễn phí cho học sinh từ lớp 1 đến lớp 12. Luyện tập các môn Toán, Lý, Hóa,... bám sát chương trình sách giáo khoa.">
    <meta property="twitter:image" content="https://hocthuoclong.github.io/trac-nghiem-online/images/logo.png">
    <!-- ============================================ -->

    <!-- Google tag (gtag.js) - Đã tích hợp -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-93QSXDCS1P"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-93QSXDCS1P');
    </script>
    <!-- Kết thúc mã Google Analytics -->


    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; }
        .card { background-color: white; border-radius: 1rem; padding: 2rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .btn { display: inline-block; text-align: center; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease-in-out; }
        .btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:not(:disabled):hover { background-color: #1d4ed8; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:not(:disabled):hover { background-color: #b91c1c; }
        .btn-secondary { background-color: #e5e7eb; color: #374151; }
        .btn-secondary:not(:disabled):hover { background-color: #d1d5db; }
        .answer-btn { border: 1px solid #d1d5db; width: 100%; }
        .answer-btn:not([disabled]):hover { background-color: #f0f9ff; border-color: #3b82f6; }
        .answer-btn.correct { background-color: #dcfce7; border-color: #22c55e; color: #166534; }
        .answer-btn.incorrect { background-color: #fee2e2; border-color: #ef4444; color: #991b1b; }
        select, input[type="text"] { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
        select { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='1.5' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='m19.5 8.25-7.5 7.5-7.5-7.5' /%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div id="app-container" class="w-full max-w-2xl mx-auto">
        <!-- Màn hình lựa chọn -->
        <div id="selection-screen" class="card">
            <div class="flex justify-center mb-4">
                <img src="./images/logo.png" alt="Logo" class="h-20 w-auto" onerror="this.style.display='none'">
            </div>
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Trắc nghiệm Online</h1>
            <p class="text-center text-gray-500 mb-8">Chọn thông tin để bắt đầu bài kiểm tra của bạn</p>
            <div class="space-y-6">
                <div>
                    <label for="grade-select" class="block mb-2 text-sm font-medium text-gray-900">Chọn lớp</label>
                    <select id="grade-select" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"></select>
                </div>
                <div>
                    <label for="subject-select" class="block mb-2 text-sm font-medium text-gray-900">Chọn môn</label>
                    <select id="subject-select" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"></select>
                </div>
                <div>
                    <label for="test-type-select" class="block mb-2 text-sm font-medium text-gray-900">Chọn loại bài kiểm tra</label>
                    <select id="test-type-select" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"></select>
                </div>
                 <div id="chapter-selection-container" class="hidden">
                    <label for="chapter-select" class="block mb-2 text-sm font-medium text-gray-900">Chọn chương</label>
                    <select id="chapter-select" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"></select>
                </div>
                <div id="name-container">
                    <label for="name-input" class="block mb-2 text-sm font-medium text-gray-900">Tên của bạn (tùy chọn)</label>
                    <input type="text" id="name-input" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Hãy nhập tên để hiển thị trong kết quả">
                </div>
            </div>
            <button id="start-btn" class="btn btn-primary mt-8 w-full">Bắt đầu làm bài</button>
            <div class="mt-8 text-center text-sm text-gray-500">
                <p>Hiện đang cập nhật liên tục các môn học cho các lớp từ 1 đến 12...</p>
                <p>Góp ý hoặc báo lỗi, vui lòng liên hệ:</p>
                <a href="mailto:hocthuoclong2k@gmail.com" class="font-medium text-blue-600 hover:underline">hocthuoclong2k@gmail.com</a>
            </div>
        </div>

        <!-- Màn hình làm bài -->
        <div id="test-screen" class="card hidden">
             <div class="flex justify-between items-center mb-6 border-b pb-4">
                <div>
                    <h2 class="text-xl font-bold text-blue-600">Bài kiểm tra</h2>
                    <p id="question-counter" class="text-sm text-gray-600">Câu 1/20</p>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-600">Thời gian</p>
                    <p id="timer" class="text-xl font-bold text-red-500">00:00</p>
                </div>
            </div>
            <div id="question-container">
                <p id="question-text" class="text-lg text-gray-800 font-medium mb-6 min-h-[60px]"></p>
                <div id="answers-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                </div>
            </div>
            <div id="navigation-buttons" class="mt-8 flex justify-between items-center">
                 <button id="submit-btn" class="btn btn-danger">Nộp bài</button>
                 <button id="next-btn" class="btn btn-primary hidden">Câu tiếp theo</button>
            </div>

            <!-- PHẦN THÔNG TIN BÁO LỖI - BẮT ĐẦU -->
            <div id="debug-info-container" class="mt-8 pt-4 border-t border-gray-200 text-xs text-gray-500">
                <p class="font-bold mb-2">Thông tin bài kiểm tra:</p>
                <p><strong>id:</strong> <span id="debug-info"></span></p>
                <p class="mt-4 italic">
                    Khi phát hiện câu hỏi có sai sót (nội dung, đáp án sai,...) hoặc lỗi hệ thống, bạn vui lòng chụp lại màn hình kèm theo "Thông tin bài kiểm tra" ở trên và gửi về email 
                    <a href="mailto:hocthuoclong2k@gmail.com" class="font-medium text-blue-600 hover:underline">hocthuoclong2k@gmail.com</a>.
                    Xin chân thành cảm ơn sự đóng góp của bạn!
                </p>
            </div>
            <!-- PHẦN THÔNG TIN BÁO LỖI - KẾT THÚC -->
        </div>
        
        <!-- Màn hình kết quả -->
        <div id="result-screen" class="card hidden text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Hoàn thành!</h2>
            <p id="result-title" class="text-lg text-gray-600 mb-2">Đây là kết quả của bạn:</p>
            <p id="user-name-display" class="text-2xl font-bold text-gray-700 mb-1"></p>
            <p id="start-time-display" class="text-xs text-gray-500 mb-6"></p>

            <div class="flex justify-around items-center bg-blue-50 p-6 rounded-lg mb-6">
                <div>
                    <p class="text-sm text-blue-800">Điểm số</p>
                    <p id="score" class="text-4xl font-bold text-blue-600">18/20</p>
                </div>
                <div class="border-l-2 border-blue-200 h-16"></div>
                <div>
                    <p class="text-sm text-blue-800">Thời gian làm bài</p>
                    <p id="time-taken" class="text-4xl font-bold text-blue-600">05:32</p>
                </div>
            </div>
            <p id="result-remark" class="text-xl font-semibold mb-6"></p>

            <div class="flex flex-col sm:flex-row gap-4">
                <button id="retry-btn" class="btn btn-primary flex-1">Làm lại bài này</button>
                <button id="home-btn" class="btn btn-secondary flex-1">Về trang chủ</button>
            </div>

            <!-- PHẦN THÔNG TIN ỦNG HỘ -->
            <div class="mt-12 pt-8 border-t border-gray-200">
                <h3 class="text-lg font-semibold text-gray-700">Thấy ứng dụng hữu ích?</h3>
                <p class="mt-2 text-sm text-gray-600">
                    Nếu bạn thấy ứng dụng này giúp ích cho việc học tập, hãy cân nhắc ủng hộ một ly cà phê để giúp tác giả duy trì và phát triển thêm nhiều tính năng mới. Mọi sự đóng góp, dù nhỏ nhất, đều là nguồn động viên to lớn.
                </p>
                <div class="mt-6 flex flex-col sm:flex-row items-center justify-center gap-8">
                    <!-- Mã QR -->
                    <div class="flex-shrink-0">
                        <img src="./images/ma-qr.jpeg" alt="Mã QR ủng hộ" class="rounded-lg shadow-md w-40 h-40" onerror="this.style.display='none'">
                    </div>
                    <!-- Thông tin ngân hàng -->
                    <div class="text-left text-sm">
                        <p class="font-medium text-gray-800">Ngân hàng: <span class="font-normal text-gray-600">ACB</span></p>
                        <p class="mt-2 font-medium text-gray-800">Số tài khoản: <span class="font-normal text-gray-600">33505737</span></p>
                        <p class="mt-2 font-medium text-gray-800">Chủ tài khoản: <span class="font-normal text-gray-600">HUYNH THI KIM DINH</span></p>
                    </div>
                </div>
                 <p class="mt-6 text-xs text-gray-500 italic">
                    Đây là hình thức ủng hộ hoàn toàn tự nguyện, không phải là một khoản phí bắt buộc để sử dụng ứng dụng.
                </p>
            </div>
            <!-- KẾT THÚC PHẦN ỦNG HỘ -->
        </div>
        
        <!-- Modal xác nhận nộp bài -->
        <div id="confirm-modal" class="modal-overlay hidden">
            <div class="card w-full max-w-sm">
                <h3 class="text-xl font-bold text-center mb-4">Xác nhận nộp bài</h3>
                <p class="text-center text-gray-600 mb-6">Bạn có chắc chắn muốn kết thúc bài làm tại đây không?</p>
                <div class="flex justify-center gap-4">
                    <button id="cancel-submit-btn" class="btn btn-secondary">Hủy</button>
                    <button id="confirm-submit-btn" class="btn btn-danger">Nộp bài</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const selectionScreen = document.getElementById('selection-screen');
        const testScreen = document.getElementById('test-screen');
        const resultScreen = document.getElementById('result-screen');
        const confirmModal = document.getElementById('confirm-modal');
        const gradeSelect = document.getElementById('grade-select');
        const subjectSelect = document.getElementById('subject-select');
        const testTypeSelect = document.getElementById('test-type-select');
        const chapterSelectionContainer = document.getElementById('chapter-selection-container');
        const chapterSelect = document.getElementById('chapter-select');
        const startBtn = document.getElementById('start-btn');
        const questionCounter = document.getElementById('question-counter');
        const timerEl = document.getElementById('timer');
        const questionText = document.getElementById('question-text');
        const answersContainer = document.getElementById('answers-container');
        const nextBtn = document.getElementById('next-btn');
        const submitBtn = document.getElementById('submit-btn');
        const scoreEl = document.getElementById('score');
        const timeTakenEl = document.getElementById('time-taken');
        const retryBtn = document.getElementById('retry-btn');
        const homeBtn = document.getElementById('home-btn');
        const confirmSubmitBtn = document.getElementById('confirm-submit-btn');
        const cancelSubmitBtn = document.getElementById('cancel-submit-btn');
        const debugInfoEl = document.getElementById('debug-info');
        const nameInput = document.getElementById('name-input');
        const userNameDisplay = document.getElementById('user-name-display');
        const startTimeDisplay = document.getElementById('start-time-display');
        const resultRemark = document.getElementById('result-remark');
        const resultTitle = document.getElementById('result-title'); // Lấy phần tử tiêu đề kết quả

        // --- State ---
        let gradeData = {};
        let subjectListData = {};
        let currentSubjectDb = {};
        
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let timerInterval;
        let startTime;
        let testStartTimeString = '';
        let lastSelections = {};

        // --- Utility Functions ---
        async function fetchData(path) {
            try {
                const response = await fetch(`${path}?v=${new Date().getTime()}`); // Cache busting
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`Không thể tải dữ liệu từ: ${path}`, error);
                alert(`Đã xảy ra lỗi khi tải dữ liệu. Vui lòng kiểm tra lại đường dẫn file.`);
                return null;
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- Population Functions ---

        async function initializeApp() {
            gradeData = await fetchData('./db-grade.json');
            subjectListData = await fetchData('./db-subject.json');

            if (!gradeData || !subjectListData) return;

            gradeSelect.innerHTML = '';
            gradeData.grades.forEach(grade => {
                const option = document.createElement('option');
                option.value = grade.id;
                option.textContent = grade.name;
                gradeSelect.appendChild(option);
            });

            subjectSelect.innerHTML = '';
            subjectListData.subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.path;
                option.textContent = subject.name;
                subjectSelect.appendChild(option);
            });
            
            await populateTestTypes();
        }

        async function populateTestTypes() {
            const subjectPath = subjectSelect.value;
            const gradeId = gradeSelect.value;
            if (!subjectPath || !gradeId) return;

            currentSubjectDb = await fetchData(subjectPath);
            const gradeContent = currentSubjectDb?.grades?.[gradeId];

            if (!gradeContent || !gradeContent.tests) {
                testTypeSelect.innerHTML = '<option>Không có bài kiểm tra</option>';
                chapterSelectionContainer.classList.add('hidden');
                return;
            };

            testTypeSelect.innerHTML = '';
            Object.keys(gradeContent.tests).forEach(testKey => {
                const option = document.createElement('option');
                option.value = testKey;
                option.textContent = gradeContent.tests[testKey].name;
                testTypeSelect.appendChild(option);
            });
            populateChapters();
        }

        function populateChapters() {
            const gradeId = gradeSelect.value;
            const testType = testTypeSelect.value;
            const testData = currentSubjectDb?.grades?.[gradeId]?.tests?.[testType];

            if (testType === 'chapter' && testData?.chapters) {
                chapterSelect.innerHTML = '';
                testData.chapters.forEach((chapter, index) => {
                    const option = document.createElement('option');
                    option.value = chapter.file; 
                    option.textContent = chapter.name;
                    chapterSelect.appendChild(option);
                });
                chapterSelectionContainer.classList.remove('hidden');
            } else {
                chapterSelectionContainer.classList.add('hidden');
            }
        }

        // --- Test Logic ---

        async function startTest(isRetry = false) {
            let questionFilePath;
            let userName;

            if (isRetry) {
                questionFilePath = lastSelections.filePath;
                userName = lastSelections.userName;
                testStartTimeString = lastSelections.startTimeString;
                // Không cần lấy lại gradeName, subjectName, testName vì đã có trong lastSelections
            } else {
                const gradeId = gradeSelect.value;
                const testType = testTypeSelect.value;
                const testData = currentSubjectDb?.grades?.[gradeId]?.tests?.[testType];

                if (testType === 'chapter') {
                    questionFilePath = chapterSelect.value;
                } else {
                    questionFilePath = testData?.file;
                }
                
                userName = nameInput.value.trim() || 'Bạn';
                
                const now = new Date();
                testStartTimeString = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')} - Ngày ${now.getDate()}/${now.getMonth() + 1}/${now.getFullYear()}`;

                // Lấy tên lớp, tên môn học và tên bài kiểm tra
                const gradeName = gradeSelect.options[gradeSelect.selectedIndex].text;
                const subjectName = subjectSelect.options[subjectSelect.selectedIndex].text;
                let testName = '';

                if (testType === 'chapter') {
                    const fullChapterName = chapterSelect.options[chapterSelect.selectedIndex].text;
                    // Lấy phần "Chương X" bằng cách tách chuỗi tại dấu ":"
                    testName = fullChapterName.split(':')[0].trim();
                } else {
                    // Lấy tên của loại bài kiểm tra (Giữa kỳ, Cuối kỳ)
                    testName = testTypeSelect.options[testTypeSelect.selectedIndex].text;
                }

                lastSelections = { 
                    filePath: questionFilePath,
                    userName: userName,
                    startTimeString: testStartTimeString,
                    gradeName: gradeName,
                    subjectName: subjectName,
                    testName: testName // Lưu tên bài kiểm tra đã được xử lý
                };
            }

            if (!questionFilePath) {
                alert('Không tìm thấy bài kiểm tra cho lựa chọn này.');
                return;
            }

            startBtn.disabled = true;
            startBtn.innerHTML = 'Đang tải dữ liệu...';

            try {
                const questionBank = await fetchData(questionFilePath);
                if (!questionBank || questionBank.length === 0) {
                    alert('Ngân hàng câu hỏi cho lựa chọn này đang trống.');
                    return;
                }

                const indexedQuestionBank = questionBank.map((q, index) => ({ ...q, originalIndex: index + 1 }));
                
                currentQuestions = shuffleArray([...indexedQuestionBank]).slice(0, 20);
                if (currentQuestions.length === 0) {
                    alert('Không đủ câu hỏi trong ngân hàng để tạo bài kiểm tra.');
                    return;
                }

                currentQuestionIndex = 0;
                score = 0;

                selectionScreen.classList.add('hidden');
                resultScreen.classList.add('hidden');
                testScreen.classList.remove('hidden');
                nextBtn.classList.add('hidden');
                submitBtn.classList.remove('hidden');

                displayQuestion();
                startTimer();

            } catch (error) {
                console.error('Lỗi khi bắt đầu bài kiểm tra:', error);
            } finally {
                startBtn.disabled = false;
                startBtn.innerHTML = 'Bắt đầu làm bài';
            }
        }

        function displayQuestion() {
            if (currentQuestionIndex >= currentQuestions.length) {
                endTest();
                return;
            }

            const question = currentQuestions[currentQuestionIndex];
            questionCounter.textContent = `Câu ${currentQuestionIndex + 1}/${currentQuestions.length}`;
            questionText.innerHTML = question.question;

            answersContainer.innerHTML = '';
            const shuffledOptions = shuffleArray([...question.options]);

            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.innerHTML = option;
                button.classList.add('btn', 'answer-btn', 'p-4', 'text-left');
                button.addEventListener('click', () => selectAnswer(button, option, question.correctAnswer));
                answersContainer.appendChild(button);
            });
            
            nextBtn.classList.add('hidden');
            nextBtn.textContent = "Câu tiếp theo";
            if (currentQuestionIndex === currentQuestions.length - 1) {
                nextBtn.textContent = "Hoàn thành";
            }
            
            updateDebugInfo();
        }

        function selectAnswer(selectedButton, selectedOption, correctAnswer) {
            const isCorrect = selectedOption === correctAnswer;
            if (isCorrect) {
                score++;
                selectedButton.classList.add('correct');
            } else {
                selectedButton.classList.add('incorrect');
            }

            Array.from(answersContainer.children).forEach(button => {
                button.disabled = true;
                if (button.innerHTML === correctAnswer) {
                    button.classList.add('correct');
                }
            });

            nextBtn.classList.remove('hidden');
        }

        function nextQuestion() {
            currentQuestionIndex++;
            displayQuestion();
        }

        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsedTime = Date.now() - startTime;
                const minutes = Math.floor(elapsedTime / 60000);
                const seconds = Math.floor((elapsedTime % 60000) / 1000);
                timerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        function endTest() {
            clearInterval(timerInterval);
            const timeTaken = timerEl.textContent;
            
            const percentage = (score / currentQuestions.length) * 100;
            let remark = '';
            let remarkColorClass = '';

            if (percentage === 100) {
                remark = '🎉 Quá xuất sắc! 🎉';
                remarkColorClass = 'text-green-500';
            } else if (percentage >= 66) {
                remark = 'Làm rất tốt!';
                remarkColorClass = 'text-blue-500';
            } else if (percentage >= 50) {
                remark = 'Làm khá lắm!';
                remarkColorClass = 'text-yellow-500';
            } else {
                remark = 'Cố gắng hơn nữa nhé!';
                remarkColorClass = 'text-red-500';
            }

            // Cập nhật tiêu đề kết quả
            resultTitle.textContent = `Kết quả kiểm tra ${lastSelections.gradeName} ${lastSelections.subjectName} ${lastSelections.testName} của:`;

            userNameDisplay.textContent = lastSelections.userName;
            startTimeDisplay.textContent = `Thời gian bắt đầu: ${lastSelections.startTimeString}`;
            scoreEl.textContent = `${score}/${currentQuestions.length}`;
            timeTakenEl.textContent = timeTaken;
            resultRemark.textContent = remark;
            resultRemark.className = `text-xl font-semibold mb-6 ${remarkColorClass}`;

            testScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');
            confirmModal.classList.add('hidden');
        }
        
        function updateDebugInfo() {
            if (!currentQuestions[currentQuestionIndex]) return;

            const question = currentQuestions[currentQuestionIndex];
            const filePath = lastSelections.filePath || 'unknown_file';
            const fileName = filePath.substring(filePath.lastIndexOf('/') + 1);
            const questionId = question.originalIndex || 'N/A';
            
            debugInfoEl.textContent = `${fileName} - câu số ${questionId}`;
        }

        // --- Navigation and UI Functions ---
        function goHome() {
            resultScreen.classList.add('hidden');
            selectionScreen.classList.remove('hidden');
        }
        
        function showConfirmModal() {
            confirmModal.classList.remove('hidden');
        }

        function hideConfirmModal() {
            confirmModal.classList.add('hidden');
        }

        // --- Event Listeners ---
        gradeSelect.addEventListener('change', populateTestTypes);
        subjectSelect.addEventListener('change', populateTestTypes);
        testTypeSelect.addEventListener('change', populateChapters);
        startBtn.addEventListener('click', () => startTest(false));
        nextBtn.addEventListener('click', nextQuestion);
        retryBtn.addEventListener('click', () => startTest(true));
        homeBtn.addEventListener('click', goHome);
        submitBtn.addEventListener('click', showConfirmModal);
        confirmSubmitBtn.addEventListener('click', endTest);
        cancelSubmitBtn.addEventListener('click', hideConfirmModal);

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>
